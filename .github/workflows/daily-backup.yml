name: Daily Backup

on:
  schedule:
    # Tous les jours Ã  2h du matin UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup'
        required: true
        type: choice
        options:
          - daily
          - weekly
          - manual
        default: 'daily'

jobs:
  backup-firestore:
    name: Backup Firestore
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Export Firestore
        run: |
          DATE=$(date +%Y%m%d)
          BACKUP_PATH="gs://attendancex-backups/firestore/${DATE}"
          
          echo "ğŸ“¦ Starting Firestore export to ${BACKUP_PATH}"
          
          gcloud firestore export ${BACKUP_PATH} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --async
          
          echo "âœ… Firestore export initiated"
      
      - name: Verify Backup
        run: |
          DATE=$(date +%Y%m%d)
          sleep 60  # Attendre que l'export dÃ©marre
          
          gsutil ls gs://attendancex-backups/firestore/${DATE}/ || \
            (echo "âŒ Backup verification failed" && exit 1)
          
          echo "âœ… Backup verified"
      
      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Daily backup completed successfully"
          # Ajouter notification Slack/Email ici
      
      - name: Notify Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Daily Firestore backup failed',
              body: `Automated backup failed on ${new Date().toISOString()}. Immediate action required.`,
              labels: ['critical', 'backup', 'ops']
            })

  backup-storage:
    name: Backup Cloud Storage
    runs-on: ubuntu-latest
    
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Sync Storage Buckets
        run: |
          DATE=$(date +%Y%m%d)
          
          echo "ğŸ“¦ Syncing storage buckets"
          
          # Backup uploads bucket
          gsutil -m rsync -r -d \
            gs://attendancex-uploads \
            gs://attendancex-backups/storage/${DATE}/uploads
          
          echo "âœ… Storage backup completed"

  backup-secrets:
    name: Backup Secrets (Metadata Only)
    runs-on: ubuntu-latest
    if: github.event.inputs.backup_type == 'weekly' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: List Secrets (Metadata)
        run: |
          DATE=$(date +%Y%m%d)
          
          echo "ğŸ“ Backing up secrets metadata"
          
          gcloud secrets list --format="table(name,createTime,labels)" \
            > secrets-metadata-${DATE}.txt
          
          echo "âœ… Secrets metadata backed up"
      
      - name: Upload Metadata
        uses: actions/upload-artifact@v3
        with:
          name: secrets-metadata
          path: secrets-metadata-*.txt
          retention-days: 90

  cleanup-old-backups:
    name: Cleanup Old Backups
    runs-on: ubuntu-latest
    needs: [backup-firestore, backup-storage]
    if: github.event.inputs.backup_type == 'weekly' || github.event_name == 'schedule'
    
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Delete Old Backups
        run: |
          # Supprimer les backups > 90 jours
          CUTOFF_DATE=$(date -d '90 days ago' +%Y%m%d)
          
          echo "ğŸ—‘ï¸ Deleting backups older than ${CUTOFF_DATE}"
          
          gsutil ls gs://attendancex-backups/firestore/ | \
            awk -v cutoff="${CUTOFF_DATE}" '$0 < cutoff' | \
            xargs -r gsutil -m rm -r
          
          echo "âœ… Old backups cleaned up"

  generate-report:
    name: Generate Backup Report
    runs-on: ubuntu-latest
    needs: [backup-firestore, backup-storage, backup-secrets]
    if: always()
    
    steps:
      - name: Create Backup Report
        run: |
          cat > backup-report.md << EOF
          # Backup Report
          
          **Date:** $(date)
          **Type:** ${{ github.event.inputs.backup_type || 'daily' }}
          
          ## Status
          
          - Firestore: ${{ needs.backup-firestore.result }}
          - Storage: ${{ needs.backup-storage.result }}
          - Secrets: ${{ needs.backup-secrets.result }}
          
          ## Next Steps
          
          - [ ] Verify backup integrity
          - [ ] Test restoration (monthly)
          - [ ] Update documentation
          
          EOF
          
          cat backup-report.md
      
      - name: Upload Report
        uses: actions/upload-artifact@v3
        with:
          name: backup-report
          path: backup-report.md
          retention-days: 30
