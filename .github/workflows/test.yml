# .github/workflows/test.yml - Tests complets pour AttendanceX
name: ðŸ§ª Tests & Quality

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # ðŸ” Analyse de code et linting
  code-quality:
    name: ðŸ“Š Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd frontend && npm ci
          cd ../backend/functions && npm ci

      - name: ðŸ” ESLint - Frontend
        run: cd frontend && npm run lint

      - name: ðŸ” ESLint - Backend
        run: cd backend/functions && npm run lint

      - name: ðŸŽ¨ Prettier check
        run: |
          cd frontend && npm run format:check
          cd ../backend/functions && npm run format:check

      - name: ðŸ“Š TypeScript check - Frontend
        run: cd frontend && npm run type-check

      - name: ðŸ“Š TypeScript check - Backend
        run: cd backend/functions && npm run type-check

  # ðŸ§ª Tests Frontend
  frontend-tests:
    name: ðŸŽ¨ Frontend Tests
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: cd frontend && npm ci

      - name: ðŸ§ª Run unit tests
        run: cd frontend && npm run test:unit

      - name: ðŸ§ª Run integration tests
        run: cd frontend && npm run test:integration

      - name: ðŸ“Š Generate coverage report
        run: cd frontend && npm run test:coverage

      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  # ðŸ”§ Tests Backend
  backend-tests:
    name: âš™ï¸ Backend Tests
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      # Firebase Emulator pour les tests
      firebase:
        image: firebase/firebase-tools:latest
        options: --health-cmd "firebase --version" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ Setup Python (for ML dependencies)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          cd backend/functions && npm ci
          pip install tensorflow numpy pandas scikit-learn

      - name: ðŸ”¥ Setup Firebase Emulator
        run: |
          npm install -g firebase-tools
          cd backend && firebase emulators:start --only firestore,auth --detach

      - name: ðŸ§ª Run unit tests
        run: cd backend/functions && npm run test:unit
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099

      - name: ðŸ§ª Run integration tests
        run: cd backend/functions && npm run test:integration
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099

      - name: ðŸ¤– Test ML/AI services
        run: cd backend/functions && npm run test:ml
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: ðŸ“Š Generate coverage report
        run: cd backend/functions && npm run test:coverage

      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/functions/coverage/lcov.info
          flags: backend
          name: backend-coverage

  # ðŸ§ª Tests End-to-End
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd frontend && npm ci
          cd ../backend/functions && npm ci

      - name: ðŸ”¥ Setup Firebase Emulator
        run: |
          npm install -g firebase-tools
          cd backend && firebase emulators:start --only firestore,auth,functions --detach

      - name: ðŸš€ Build frontend
        run: cd frontend && npm run build

      - name: ðŸŽ­ Install Playwright
        run: cd tests && npx playwright install --with-deps

      - name: ðŸ§ª Run E2E tests
        run: cd tests && npm run test:e2e
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          FIREBASE_EMULATOR_HOST: localhost:5001

      - name: ðŸ“¸ Upload test artifacts
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: tests/playwright-report/

  # ðŸ”’ Tests de sÃ©curitÃ©
  security-tests:
    name: ðŸ”’ Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd frontend && npm ci
          cd ../backend/functions && npm ci

      - name: ðŸ” Run npm audit - Frontend
        run: cd frontend && npm audit --audit-level moderate

      - name: ðŸ” Run npm audit - Backend
        run: cd backend/functions && npm audit --audit-level moderate

      - name: ðŸ›¡ï¸ Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ðŸš€ Build et dÃ©ploiement de test
  build-and-deploy:
    name: ðŸš€ Build & Deploy Preview
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd frontend && npm ci
          cd ../backend/functions && npm ci

      - name: ðŸ—ï¸ Build frontend
        run: cd frontend && npm run build
        env:
          VITE_API_URL: ${{ secrets.PREVIEW_API_URL }}
          VITE_FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}

      - name: ðŸ—ï¸ Build backend functions
        run: cd backend/functions && npm run build

      - name: ðŸš€ Deploy to Firebase Preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: 'pr-${{ github.event.number }}'
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels

  # ðŸ“Š Rapport de qualitÃ© final
  quality-report:
    name: ðŸ“Š Quality Report
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-tests, backend-tests, e2e-tests, security-tests]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Generate quality report
        run: |
          echo "## ðŸ“Š Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests | ${{ needs.security-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– ML/AI Features Tested" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Attendance Prediction Service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Anomaly Detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Recommendation Engine" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ML Model Management" >> $GITHUB_STEP_SUMMARY