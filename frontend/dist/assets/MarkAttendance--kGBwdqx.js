import{c as de,w as oe,z as me,y as f,j as e,a as b,B as T,o as ue,G as O,H as Q,I as G,U as xe}from"./index-gm4XY7Dh.js";import{h as he,d as je,r as m}from"./vendor-CvUQ7FSA.js";import{C as u,a as x,b as ve,c as fe}from"./Card-ct0JxCCf.js";import{I as pe}from"./Input-BoijLIkg.js";import{S as C,a as y,b as S,c as w,d as n}from"./select-byvKiojp.js";import{T as H}from"./textarea-DCMMGiR1.js";import{A as ge,a as Ne}from"./alert-dbwOQxjT.js";import{T as be,a as Ce,b as X,c as J}from"./tabs-unnrqVzs.js";import{e as ye}from"./eventService-DkagHfbT.js";import{a as K}from"./attendanceService-BE_yyzd4.js";import{C as $}from"./circle-alert-B-efKsjX.js";import{A as Se}from"./arrow-left-yMfWrytx.js";import{S as we}from"./save-BsTaTsK9.js";import{T as W}from"./timer-grUHIzZ1.js";import{C as ke}from"./circle-x-B_KOwtkV.js";import{C as Ie}from"./circle-check-big-eEft8Q46.js";import{S as Ae}from"./smartphone-P3L5Q6Fc.js";import{U as Y}from"./user-check-C2Vgj06z.js";import{M as Te}from"./map-pin-Dg8dt4LF.js";import{Q as Ee}from"./qr-code-CxuDgFNJ.js";import"./firebase-De9GV7Vy.js";import"./index-TMJn6bF9.js";import"./chevron-down-L5bpcUyJ.js";import"./check-Cx9i6ejF.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],Pe=de("camera",Me),rs=()=>{const{eventId:p}=he(),E=je(),{user:g}=oe(),{canManageAttendances:Z}=me(),[B,ee]=m.useState(null),[o,M]=m.useState([]),[Le,se]=m.useState([]),[te,q]=m.useState(!0),[_,U]=m.useState(!1),[N,ae]=m.useState(""),[P,re]=m.useState("all"),[j,L]=m.useState({status:"present",method:"manual",notes:""}),[v,k]=m.useState([]);m.useEffect(()=>{p&&ne()},[p]);const ne=async()=>{var s;try{q(!0);const t=await ye.getEventById(p);if(!t.success||!t.data){f.error("Événement non trouvé"),E("/events");return}const r=t.data;ee(r);const a=await K.getEventAttendances(p),l=a.success?a.data:[];se(l);const d=((s=r.participants)==null?void 0:s.map(c=>{const i=l.find(A=>A.userId===c.id);return{userId:c.id,user:c,status:(i==null?void 0:i.status)||"absent",method:(i==null?void 0:i.method)||"manual",notes:(i==null?void 0:i.notes)||"",checkInTime:i==null?void 0:i.checkInTime,checkOutTime:i==null?void 0:i.checkOutTime,isModified:!1}}))||[];M(d)}catch(t){console.error("Error loading event and attendances:",t),f.error("Erreur lors du chargement"),E("/events")}finally{q(!1)}},I=(s,t)=>{M(r=>r.map(a=>a.userId===s?{...a,...t,isModified:!0}:a))},R=s=>{const r={present:{variant:"default",label:"Présent",icon:Ie},absent:{variant:"destructive",label:"Absent",icon:ke},late:{variant:"secondary",label:"En retard",icon:W},excused:{variant:"outline",label:"Excusé",icon:$},left_early:{variant:"secondary",label:"Parti tôt",icon:W}}[s]||{variant:"outline",label:s,icon:$},a=r.icon;return e.jsxs(T,{variant:r.variant,className:"flex items-center gap-1",children:[e.jsx(a,{className:"w-3 h-3"}),r.label]})},le=s=>{const r={qr_code:{variant:"default",label:"QR Code",icon:Ee},geolocation:{variant:"secondary",label:"Géolocalisation",icon:Te},manual:{variant:"outline",label:"Manuel",icon:Y},biometric:{variant:"default",label:"Biométrique",icon:Pe},nfc:{variant:"secondary",label:"NFC",icon:Ae}}[s]||{variant:"outline",label:s,icon:Y},a=r.icon;return e.jsxs(T,{variant:r.variant,className:"flex items-center gap-1",children:[e.jsx(a,{className:"w-3 h-3"}),r.label]})},V=s=>{var t;if(s!=null&&s.firstName&&(s!=null&&s.lastName))return`${s.firstName[0]}${s.lastName[0]}`.toUpperCase();if(s!=null&&s.displayName){const r=s.displayName.split(" ");return r.length>1?`${r[0][0]}${r[1][0]}`.toUpperCase():r[0][0].toUpperCase()}return((t=s==null?void 0:s.email)==null?void 0:t[0].toUpperCase())||"U"},ie=()=>{if(v.length===0){f.warning("Aucun participant sélectionné");return}v.forEach(s=>{I(s,{status:j.status,method:j.method,notes:j.notes,checkInTime:j.status==="present"?new Date().toISOString():void 0})}),k([]),f.success(`${v.length} présence(s) mise(s) à jour`)},ce=async()=>{const s=o.filter(t=>t.isModified);if(s.length===0){f.info("Aucune modification à sauvegarder");return}try{U(!0);const t=s.reduce((a,l)=>(a[l.status]||(a[l.status]=[]),a[l.status].push(l.userId),a),{}),r=Object.entries(t).map(([a,l])=>{const d=a==="present"?"mark_present":a==="late"?"mark_late":"mark_absent";return K.bulkMarkAttendance(d,p,l,`Marquage manuel par ${(g==null?void 0:g.displayName)||(g==null?void 0:g.email)}`)});await Promise.all(r),f.success("Présences sauvegardées avec succès"),M(a=>a.map(l=>({...l,isModified:!1})))}catch(t){console.error("Error saving attendances:",t),f.error("Erreur lors de la sauvegarde")}finally{U(!1)}},z=o.filter(s=>{var a,l,d,c,i,A,F,D;const t=!N||((l=(a=s.user)==null?void 0:a.displayName)==null?void 0:l.toLowerCase().includes(N.toLowerCase()))||((c=(d=s.user)==null?void 0:d.firstName)==null?void 0:c.toLowerCase().includes(N.toLowerCase()))||((A=(i=s.user)==null?void 0:i.lastName)==null?void 0:A.toLowerCase().includes(N.toLowerCase()))||((D=(F=s.user)==null?void 0:F.email)==null?void 0:D.toLowerCase().includes(N.toLowerCase())),r=P==="all"||s.status===P;return t&&r}),h={total:o.length,present:o.filter(s=>s.status==="present").length,absent:o.filter(s=>s.status==="absent").length,late:o.filter(s=>s.status==="late").length,excused:o.filter(s=>s.status==="excused").length,modified:o.filter(s=>s.isModified).length};return te?e.jsx("div",{className:"container-fluid py-6",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-muted rounded w-1/3"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[...Array(4)].map((s,t)=>e.jsx("div",{className:"h-24 bg-muted rounded"},t))}),e.jsx("div",{className:"h-96 bg-muted rounded"})]})}):!B||!Z?e.jsx("div",{className:"container-fluid py-6",children:e.jsxs(ge,{variant:"destructive",children:[e.jsx($,{className:"h-4 w-4"}),e.jsx(Ne,{children:"Vous n'avez pas les permissions pour marquer les présences de cet événement."})]})}):e.jsxs("div",{className:"container-fluid py-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>E(`/events/${p}`),children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Retour à l'événement"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Marquer les présences"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:B.title})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[h.modified>0&&e.jsxs(T,{variant:"secondary",children:[h.modified," modification(s) en attente"]}),e.jsxs(b,{onClick:ce,disabled:_||h.modified===0,children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),_?"Sauvegarde...":"Sauvegarder"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(u,{children:e.jsxs(x,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:h.total}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total"})]})}),e.jsx(u,{children:e.jsxs(x,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:h.present}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Présents"})]})}),e.jsx(u,{children:e.jsxs(x,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:h.absent}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Absents"})]})}),e.jsx(u,{children:e.jsxs(x,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:h.late}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"En retard"})]})}),e.jsx(u,{children:e.jsxs(x,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-600",children:h.excused}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Excusés"})]})})]}),e.jsxs(be,{defaultValue:"individual",className:"space-y-6",children:[e.jsxs(Ce,{children:[e.jsx(X,{value:"individual",children:"Marquage individuel"}),e.jsx(X,{value:"bulk",children:"Actions groupées"})]}),e.jsxs(J,{value:"individual",className:"space-y-6",children:[e.jsx(u,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(pe,{placeholder:"Rechercher un participant...",value:N,onChange:s=>ae(s.target.value),className:"pl-10"})]})}),e.jsxs(C,{value:P,onValueChange:s=>re(s),children:[e.jsx(y,{className:"w-[200px]",children:e.jsx(S,{placeholder:"Filtrer par statut"})}),e.jsxs(w,{children:[e.jsx(n,{value:"all",children:"Tous les statuts"}),e.jsx(n,{value:"present",children:"Présent"}),e.jsx(n,{value:"absent",children:"Absent"}),e.jsx(n,{value:"late",children:"En retard"}),e.jsx(n,{value:"excused",children:"Excusé"})]})]})]})})}),e.jsxs("div",{className:"space-y-4",children:[z.map(s=>{var t,r,a,l,d;return e.jsx(u,{className:`${s.isModified?"border-l-4 border-l-blue-500":""}`,children:e.jsxs(x,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(O,{className:"w-12 h-12",children:[e.jsx(Q,{src:(t=s.user)==null?void 0:t.profilePicture}),e.jsx(G,{children:V(s.user)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:((r=s.user)==null?void 0:r.displayName)||`${(a=s.user)==null?void 0:a.firstName} ${(l=s.user)==null?void 0:l.lastName}`}),s.isModified&&e.jsx(T,{variant:"secondary",className:"text-xs",children:"Modifié"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(d=s.user)==null?void 0:d.email}),s.checkInTime&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Arrivé le ",new Date(s.checkInTime).toLocaleString("fr-FR")]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsxs(C,{value:s.status,onValueChange:c=>I(s.userId,{status:c,checkInTime:c==="present"&&!s.checkInTime?new Date().toISOString():s.checkInTime}),children:[e.jsx(y,{className:"w-[140px]",children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(n,{value:"present",children:"Présent"}),e.jsx(n,{value:"absent",children:"Absent"}),e.jsx(n,{value:"late",children:"En retard"}),e.jsx(n,{value:"excused",children:"Excusé"}),e.jsx(n,{value:"left_early",children:"Parti tôt"})]})]}),e.jsxs(C,{value:s.method,onValueChange:c=>I(s.userId,{method:c}),children:[e.jsx(y,{className:"w-[140px]",children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(n,{value:"manual",children:"Manuel"}),e.jsx(n,{value:"qr_code",children:"QR Code"}),e.jsx(n,{value:"geolocation",children:"Géolocalisation"}),e.jsx(n,{value:"biometric",children:"Biométrique"}),e.jsx(n,{value:"nfc",children:"NFC"})]})]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[R(s.status),le(s.method)]})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(H,{placeholder:"Notes (optionnel)...",value:s.notes,onChange:c=>I(s.userId,{notes:c.target.value}),className:"resize-none",rows:2})})]})},s.userId)}),z.length===0&&e.jsx(u,{children:e.jsxs(x,{className:"p-12 text-center",children:[e.jsx(xe,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"Aucun participant trouvé"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucun participant ne correspond à vos critères de recherche."})]})})]})]}),e.jsx(J,{value:"bulk",className:"space-y-6",children:e.jsxs(u,{children:[e.jsx(ve,{children:e.jsx(fe,{children:"Actions groupées"})}),e.jsxs(x,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Statut"}),e.jsxs(C,{value:j.status,onValueChange:s=>L(t=>({...t,status:s})),children:[e.jsx(y,{children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(n,{value:"present",children:"Présent"}),e.jsx(n,{value:"absent",children:"Absent"}),e.jsx(n,{value:"late",children:"En retard"}),e.jsx(n,{value:"excused",children:"Excusé"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Méthode"}),e.jsxs(C,{value:j.method,onValueChange:s=>L(t=>({...t,method:s})),children:[e.jsx(y,{children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(n,{value:"manual",children:"Manuel"}),e.jsx(n,{value:"qr_code",children:"QR Code"}),e.jsx(n,{value:"geolocation",children:"Géolocalisation"})]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(b,{onClick:ie,disabled:v.length===0,className:"w-full",children:["Appliquer (",v.length,")"]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Notes (optionnel)"}),e.jsx(H,{placeholder:"Notes pour l'action groupée...",value:j.notes,onChange:s=>L(t=>({...t,notes:s.target.value})),rows:3})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-medium",children:"Sélectionner les participants"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(b,{variant:"outline",size:"sm",onClick:()=>k(o.map(s=>s.userId)),children:"Tout sélectionner"}),e.jsx(b,{variant:"outline",size:"sm",onClick:()=>k([]),children:"Tout désélectionner"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto",children:o.map(s=>{var t,r,a,l;return e.jsxs("div",{className:`flex items-center space-x-3 p-3 border rounded-lg cursor-pointer transition-colors ${v.includes(s.userId)?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>{k(d=>d.includes(s.userId)?d.filter(c=>c!==s.userId):[...d,s.userId])},children:[e.jsx("input",{type:"checkbox",checked:v.includes(s.userId),onChange:()=>{},className:"pointer-events-none"}),e.jsxs(O,{className:"w-8 h-8",children:[e.jsx(Q,{src:(t=s.user)==null?void 0:t.profilePicture}),e.jsx(G,{className:"text-xs",children:V(s.user)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:((r=s.user)==null?void 0:r.displayName)||`${(a=s.user)==null?void 0:a.firstName} ${(l=s.user)==null?void 0:l.lastName}`}),e.jsx("div",{className:"flex items-center space-x-2",children:R(s.status)})]})]},s.userId)})})]})]})]})})]})]})};export{rs as default};
//# sourceMappingURL=MarkAttendance--kGBwdqx.js.map
